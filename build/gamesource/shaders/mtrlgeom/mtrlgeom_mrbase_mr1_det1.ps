
/*
mtrlgeom_mrbase_mr1_det1.ps
Рендер геометрии с микрорельефом, детальной текстурой и микрорельефом для нее
*/

#include <../struct.h>
#include <../mtrl.h>

sampler2D BaseTex:register(s0);
sampler2D DetTex:register(s2);
sampler2D MRTex0:register(s6);
sampler2D MRTex1:register(s7);
sampler2D ParamTex:register(s10);

half4 Param;
half4 NearFarIsUnlit;

ps_out_ds_mrt main(vs_out_gcommon IN)
{
	ClipFar(IN.Pos.z,NearFarIsUnlit.y);

	ps_out_ds_mrt OUT; 
	OUT.Color = tex2D(BaseTex,IN.TexUV);
	half4 detcolor1 = tex2D(DetTex, (IN.TexUV) * Param.x * MTRL_TEXUV_SCALE);
	OUT.Color.rgb *= detcolor1.rgb;

	half3 NormalMicro = ((2.f * (tex2D(MRTex0, IN.TexUV).rgb)) - 1.f);
	NormalMicro *= Param.z;
	half3 mrcolor1 = (2.f * (tex2D(MRTex1, (IN.TexUV) * Param.x * MTRL_TEXUV_SCALE).rgb)) - 1.f;
	mrcolor1 *= Param.z;
	IN.Normal = normalize(IN.Normal);
	half3 NormalPixel = normalize((IN.Normal+half3((NormalMicro.xy+mrcolor1.xy),IN.Normal.z)) * 0.5f);
	
	OUT.Normal.xy = NormalEncode(NormalPixel);
	OUT.Normal.w = NearFarIsUnlit.z;
	OUT.Normal.z = NearFarIsUnlit.w;
	
	OUT.Param = tex2D(ParamTex,IN.TexUV);
	//OUT.Param.w = NearFarIsUnlit.w;
	
	OUT.Depth = GetDepthW(IN.Pos,NearFarIsUnlit.xy);
	
	return OUT;
}