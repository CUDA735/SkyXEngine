
#include <../struct.h>
#include <../mtrl.h>

sampler2D BaseSampler:register(s0);

sampler2D RF0SSIsSampler:register(s10);
samplerCUBE ReflectionSampler:register(s12);

half3 NearFarIsUnlit;

ps_out_ds_mrt main(vs_out_refcube IN)
{
	ClipFar(IN.Pos.z,NearFarIsUnlit.y);
	
	ps_out_ds_mrt OUT; 
	OUT.Color = tex2D(BaseSampler,IN.TexUV);
	
	OUT.Normal.xyz = 0.5f * IN.Normal + 0.5f;
	OUT.Normal.w = NearFarIsUnlit.z;
	
	OUT.Param = tex2D(RF0SSIsSampler,IN.TexUV);
	OUT.Param.z = NearFarIsUnlit.w;
	
	half MipmapIndex = lerp(0,10,1-OUT.Param.r);
	half4 reflection = texCUBElod(ReflectionSampler, half4(IN.CubePPos,MipmapIndex));
	OUT.Color.xyz = lerp(OUT.Color.xyz,reflection.xyz,OUT.Param.y);
	
	OUT.Depth = GetDepthW(IN.Pos,NearFarIsUnlit.xy);
	
	return OUT;
}