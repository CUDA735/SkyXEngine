
#include <../struct.h>

half4 PixelSize;

sampler2D DepthMap:register(s0);
sampler2D BlurMap:register(s1);

half2 NearFar;

half4 main(vs_out_pp IN) : COLOR0
{
	half2 BlurOffset = PixelSize;
	half2 CenterTC = IN.TexUV;

	half SumWeight = 0.125f;
	half4 Color = tex2D(BlurMap,CenterTC) * SumWeight;

	half CenterDepth = tex2D(DepthMap, CenterTC).r * NearFar.y;

		[unroll]
		for(half x=-1;x<=1;x++)
		{
				[unroll]
				for(half y=-1;y<=1;y++)
				{
					half2 SampleTC = CenterTC + half2(x * PixelSize.x,y * PixelSize.y);
					half Depth = tex2D(DepthMap, SampleTC).r;
						//if(Depth <= 0.0)
							//Depth = 1.0;
					Depth *= NearFar.y;
					half Diff = 9.0f*(1.0f - Depth/CenterDepth);
					half Weight = saturate(0.5 - 0.75f*abs(Diff) - 0.25f*(Diff));
					Color += tex2D(BlurMap,SampleTC) * Weight;
					SumWeight += Weight;
				}
		}

	Color /= SumWeight;
		//if(CenterDepth/NearFar.y <= 0)
			//Color.r = 1.0;
	return Color;
}