
#include <../struct.h>

sampler2D BaseSampler:register(s0);
sampler2D MDRSampler:register(s6);
sampler2D RF0SSIsSampler:register(s10);

float4 Param;
float2 NearFar;

ps_out_ds_mrt main(vs_out_green IN)
{
	ps_out_ds_mrt OUT; 
	OUT.Color = tex2D(BaseSampler,IN.TexUV);

	float3 NormalMicro = ((2.0 * (tex2D(MDRSampler, IN.TexUV).rgb)) - 1.0);
	NormalMicro *= ((2.f * Param.z) - 1.f) * 2.f;
	float3 NormalPixel = normalize((IN.Normal+float3(NormalMicro.xy,IN.Normal.z)) * 0.5f);
	//float3 NormalPixel = normalize(lerp(IN.Normal,float3(NormalMicro.xy,IN.Normal.z),0.5f));
	
	OUT.Normal.xyz = 0.5f * NormalPixel + 0.5f;
	OUT.Normal.w = 1.f;
	
	OUT.Param = tex2D(RF0SSIsSampler,IN.TexUV);
	
	OUT.Depth = IN.Pos.z / NearFar.y;
	
	return OUT;
}