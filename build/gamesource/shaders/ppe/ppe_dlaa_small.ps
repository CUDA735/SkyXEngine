
/*
ppe_dlaa_small.ps
Directionally Localized Anti Aliasing
Обнаружение коротких граней и их размытие
Начало данный шейдер берет отсюда: https://www.gamedev.net/forums/topic/594209-dlaa/
*/

#include <../struct.h>

#define DLAA_MUL_VAL 0.333f

sampler2D Tex0:register(s0);
sampler2D Tex1:register(s1);

half2 PixelSize;

half4 main(vs_out_pp IN) : COLOR0
{
	half4 sampleCenter = tex2Dlod(Tex0, half4(IN.TexUV,0.f,0.f));
	half fEdgeDetected = tex2Dlod(Tex1, half4(IN.TexUV,0.f,0.f));
	
	[branch]if(fEdgeDetected.x == 0.f)
		return sampleCenter;

	half4 sampleHorizNeg0 = tex2Dlod(Tex0, half4(IN.TexUV + half2(-1.5f, 0.f) * PixelSize, 0.f, 0.f));
	half4 sampleHorizPos0 = tex2Dlod(Tex0, half4(IN.TexUV + half2( 1.5f, 0.f) * PixelSize, 0.f, 0.f)); 
	half4 sampleVertNeg0 = tex2Dlod(Tex0, half4(IN.TexUV + half2(0.f, -1.5f) * PixelSize, 0.f, 0.f)); 
	half4 sampleVertPos0 = tex2Dlod(Tex0, half4(IN.TexUV + half2(0.f, 1.5f) * PixelSize, 0.f, 0.f));

	half4 sumHoriz = sampleHorizNeg0 + sampleHorizPos0;
	half4 sumVert = sampleVertNeg0  + sampleVertPos0;

	half4 diffToCenterHoriz = abs(sumHoriz - (2.f * sampleCenter)) * 0.5f;  

	half valueEdgeHoriz = dot(diffToCenterHoriz.xyz, DLAA_MUL_VAL);
	half valueEdgeVert = dot(diffToCenterHoriz.xyz, DLAA_MUL_VAL);
	
	half edgeDetectHoriz = saturate((3.f * valueEdgeHoriz) - 0.1f);
	half edgeDetectVert = saturate((3.f * valueEdgeVert)  - 0.1f);

	half4 avgHoriz = (sumHoriz + sampleCenter) * 0.333f;
	half4 avgVert = (sumVert + sampleCenter) * 0.333f;

	half valueHoriz = dot(avgHoriz.xyz, DLAA_MUL_VAL);
	half valueVert = dot(avgVert.xyz, DLAA_MUL_VAL);

	half blurAmountHoriz = saturate(edgeDetectHoriz / valueHoriz);
	half blurAmountVert = saturate(edgeDetectVert / valueVert);

	half4 aaResult = lerp(sampleCenter, avgHoriz, blurAmountHoriz);
	aaResult = lerp(aaResult, avgVert, blurAmountVert);

	//return tex2Dlod(Tex1, half4(IN.TexUV,0.f,0.f));
	return half4(aaResult.rgb, sampleCenter.a);
	return lerp(half4(aaResult.rgb, sampleCenter.a), sampleCenter, 1-fEdgeDetected.x);
}